{% extends "base.html" %}
{% block title %}Notifications{% endblock %}

{% block content %}
<style>
    .notification-icon {
    background-color: var(--notification-color);
}

.container-fluid {
    padding: 2rem;
    background: #fafafa;
    margin: 0;
    min-height: 100vh;
}

.notifications-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 1rem;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.content-section {
    background: white;
    border-radius: 1rem;
    padding: 0;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    overflow: hidden;
}

.notification-group {
    border-bottom: 1px solid #f3f4f6;
}

.notification-group:last-child {
    border-bottom: none;
}

.date-header {
    background: #f8fafc;
    padding: 1rem 2rem;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 10;
}

.notification-item {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #f3f4f6;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.notification-item:hover {
    background: #f9fafb;
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-item.unread {
    background: #f0f9ff;
    border-left: 4px solid #3b82f6;
}

.notification-item.unread:hover {
    background: #e0f2fe;
}

.notification-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.notification-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
    margin-top: 0.25rem;
}

.notification-details {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.notification-message {
    color: #6b7280;
    line-height: 1.5;
    margin-bottom: 0.75rem;
}

.notification-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.875rem;
    color: #9ca3af;
}

.notification-time {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.notification-type {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    background: #f3f4f6;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #6b7280;
}

.notification-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: auto;
    flex-shrink: 0;
}

.btn-mark-read {
    padding: 0.25rem 0.75rem;
    background: #e5e7eb;
    border: none;
    border-radius: 0.375rem;
    color: #6b7280;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-mark-read:hover {
    background: #d1d5db;
    color: #374151;
}

.btn-view {
    padding: 0.25rem 0.75rem;
    background: #3b82f6;
    border: none;
    border-radius: 0.375rem;
    color: white;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-view:hover {
    background: #2563eb;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6b7280;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.stats-bar {
    background: white;
    border-radius: 0.75rem;
    padding: 1rem 2rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.stats-item {
    text-align: center;
}

.stats-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
}

.stats-label {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.filter-tabs {
    display: flex;
    background: white;
    border-radius: 0.75rem;
    padding: 0.5rem;
    margin-bottom: 2rem;
    gap: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.filter-tab {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    color: #6b7280;
}

.filter-tab.active {
    background: #3b82f6;
    color: white;
}

.filter-tab:hover:not(.active) {
    background: #f3f4f6;
    color: #374151;
}

.mark-all-read {
    background: #10b981;
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.mark-all-read:hover {
    background: #059669;
    transform: translateY(-1px);
}

.mark-all-read:disabled {
    background: #d1d5db;
    cursor: not-allowed;
    transform: none;
}

/* Notification type specific styles */
.type-application_submitted { background: #dcfce7; color: #166534; }
.type-new_application { background: #dbeafe; color: #1e40af; }
.type-interview_scheduled { background: #fef3c7; color: #92400e; }
.type-status_update { background: #f3f4f6; color: #374151; }
.type-hired { background: #dcfce7; color: #166534; }
.type-rejected { background: #fee2e2; color: #991b1b; }

/* Responsive design */
@media (max-width: 768px) {
    .container-fluid {
        padding: 1rem;
    }
    
    .notifications-header {
        padding: 1.5rem;
        text-align: center;
    }
    
    .notification-item {
        padding: 1rem;
    }
    
    .notification-content {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .notification-icon {
        align-self: flex-start;
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
    }
    
    .notification-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .notification-actions {
        margin-left: 0;
        margin-top: 0.5rem;
    }
    
    .stats-bar {
        flex-direction: column;
        gap: 1rem;
    }
    
    .filter-tabs {
        flex-direction: column;
    }
    
    .date-header {
        padding: 0.75rem 1rem;
    }
}

/* Animation for new notifications */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.notification-item {
    animation: slideIn 0.3s ease-out;
}
</style>

<div class="container-fluid">
    <!-- Notifications Header -->
    <div class="notifications-header">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="mb-2">
                    <i class="bi bi-bell me-2"></i>Notifications
                </h2>
                <p class="mb-0 opacity-90">Stay updated with your application status and important updates</p>
            </div>
            <div class="col-auto">
                <button class="mark-all-read" onclick="markAllAsRead()" id="markAllBtn">
                    <i class="bi bi-check-all me-2"></i>Mark All as Read
                </button>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'info' }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Statistics Bar -->
    <div class="stats-bar">
        <div class="stats-item">
            <div class="stats-number" id="totalCount">{{ grouped_notifications|length or 0 }}</div>
            <div class="stats-label">Notification Groups</div>
        </div>
        <div class="stats-item">
            <div class="stats-number" id="unreadCount">
                {% set total_notifications = [] %}
                {% for date_key, group in grouped_notifications %}
                    {% for notification in group.notifications %}
                        {% if not notification.is_read %}
                            {% set _ = total_notifications.append(1) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {{ total_notifications|length }}
            </div>
            <div class="stats-label">Unread</div>
        </div>
        <div class="stats-item">
            <div class="stats-number">
                {% set total_all = [] %}
                {% for date_key, group in grouped_notifications %}
                    {% for notification in group.notifications %}
                        {% set _ = total_all.append(1) %}
                    {% endfor %}
                {% endfor %}
                {{ total_all|length }}
            </div>
            <div class="stats-label">Total Notifications</div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterNotifications('all')">
            All Notifications
        </button>
        <button class="filter-tab" onclick="filterNotifications('unread')">
            Unread Only
        </button>
        {% if user_role == 'applicant' %}
        <button class="filter-tab" onclick="filterNotifications('application')">
            Applications
        </button>
        <button class="filter-tab" onclick="filterNotifications('interview')">
            Interviews
        </button>
        {% elif user_role == 'employer' %}
        <button class="filter-tab" onclick="filterNotifications('new_application')">
            New Applications
        </button>
        <button class="filter-tab" onclick="filterNotifications('interview')">
            Interviews
        </button>
        {% endif %}
    </div>

    <!-- Notifications Content -->
    <div class="content-section">
        {% if grouped_notifications %}
            {% for date_key, group in grouped_notifications %}
            <div class="notification-group" data-date="{{ date_key }}">
                <div class="date-header">
                    <i class="bi bi-calendar3 me-2"></i>{{ group.label }}
                </div>
                
                {% for notification in group.notifications %}
               <!-- Replace the notification-item section in your notifications.html -->

<div class="notification-item {{ 'unread' if not notification.is_read else '' }}" 
     data-notification-id="{{ notification._id }}"
     data-notification-type="{{ notification.type }}"
     data-read="{{ notification.is_read|lower }}"
     data-action-url="{{ notification.action_url or '' }}"
     onclick="handleNotificationClick(this)">
    
    <div class="notification-content">
        <div class="notification-icon" style="background-color: {{ notification.color }};">
            <i class="bi bi-{{ notification.icon }}"></i>
        </div>
        
        <div class="notification-details">
            <div class="notification-title">{{ notification.title }}</div>
            <div class="notification-message">{{ notification.message }}</div>
            
            <div class="notification-meta">
                <div class="notification-time">
                    <i class="bi bi-clock me-1"></i>{{ notification.time_ago }}
                </div>
                <div class="notification-type type-{{ notification.type }}">
                    {{ notification.type|replace('_', ' ')|title }}
                </div>
                {% if not notification.is_read %}
                <div class="notification-type" style="background: #dbeafe; color: #1e40af;">
                    <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>New
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="notification-actions" onclick="event.stopPropagation();">
            {% if not notification.is_read %}
            <button class="btn-mark-read" onclick="markAsRead('{{ notification._id }}')">
                <i class="bi bi-check me-1"></i>Mark Read
            </button>
            {% endif %}
            {% if notification.action_url %}
            <button class="btn-view" onclick="viewNotification('{{ notification._id }}', '{{ notification.action_url }}')">
                <i class="bi bi-arrow-right me-1"></i>View
            </button>
            {% endif %}
        </div>
    </div>
</div>
                {% endfor %}
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">ðŸ“­</div>
                <h5>No notifications yet</h5>
                <p>You'll see important updates about your {{ 'applications and interviews' if user_role == 'applicant' else 'job postings and candidates' }} here.</p>
                {% if user_role == 'applicant' %}
                <a href="/HR1/show_job" class="btn-view">
                    <i class="bi bi-briefcase me-2"></i>Browse Jobs
                </a>
                {% else %}
                <a href="/HR1/Company_Job_Posting" class="btn-view">
                    <i class="bi bi-plus-circle me-2"></i>Post a Job
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<script>
// Global notification management functions

function viewNotification(notificationId, actionUrl) {
    // Mark as read and then redirect to the action URL
    markAsRead(notificationId, () => {
        window.location.href = actionUrl;
    });
}

function handleNotificationClick(element) {
    const notificationId = element.getAttribute('data-notification-id');
    const actionUrl = element.getAttribute('data-action-url');
    
    if (actionUrl) {
        // Mark as read and redirect
        markAsRead(notificationId, () => {
            window.location.href = actionUrl;
        });
    } else {
        // Just mark as read
        markAsRead(notificationId);
    }
}

function markAsRead(notificationId, callback) {
    fetch(`/mark_notification_read/${notificationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('unread');
                notificationElement.setAttribute('data-read', 'true');
                
                // Remove the "Mark Read" button
                const markReadBtn = notificationElement.querySelector('.btn-mark-read');
                if (markReadBtn) {
                    markReadBtn.remove();
                }
                
                // Remove "New" badge
                const newBadges = notificationElement.querySelectorAll('.notification-type');
                newBadges.forEach(badge => {
                    if (badge.textContent.includes('New')) {
                        badge.remove();
                    }
                });
            }
            
            // Update unread count
            updateUnreadCount();
            
            if (callback) callback();
        } else {
            showNotification('Failed to mark notification as read', 'error');
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
        showNotification('Error updating notification', 'error');
    });
}

function markAllAsRead() {
    const unreadNotifications = document.querySelectorAll('.notification-item.unread');
    
    if (unreadNotifications.length === 0) {
        showNotification('No unread notifications', 'info');
        return;
    }
    
    const markAllBtn = document.getElementById('markAllBtn');
    markAllBtn.disabled = true;
    markAllBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Marking...';
    
    fetch('/mark_all_notifications_read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update all notification elements
            unreadNotifications.forEach(notification => {
                notification.classList.remove('unread');
                notification.setAttribute('data-read', 'true');
                
                const markReadBtn = notification.querySelector('.btn-mark-read');
                if (markReadBtn) {
                    markReadBtn.remove();
                }
                
                const newBadges = notification.querySelectorAll('.notification-type');
                newBadges.forEach(badge => {
                    if (badge.textContent.includes('New')) {
                        badge.remove();
                    }
                });
            });
            
            updateUnreadCount();
            showNotification(`Marked ${data.count || unreadNotifications.length} notifications as read`, 'success');
        } else {
            showNotification('Failed to mark all notifications as read', 'error');
        }
    })
    .catch(error => {
        console.error('Error marking all notifications as read:', error);
        showNotification('Error updating notifications', 'error');
    })
    .finally(() => {
        markAllBtn.disabled = false;
        markAllBtn.innerHTML = '<i class="bi bi-check-all me-2"></i>Mark All as Read';
    });
}

function filterNotifications(filterType) {
    // Update active tab
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filter notifications
    const notifications = document.querySelectorAll('.notification-item');
    
    notifications.forEach(notification => {
        const notificationType = notification.getAttribute('data-notification-type');
        const isRead = notification.getAttribute('data-read') === 'true';
        
        let shouldShow = true;
        
        switch (filterType) {
            case 'all':
                shouldShow = true;
                break;
            case 'unread':
                shouldShow = !isRead;
                break;
            case 'application':
                shouldShow = notificationType.includes('application') || notificationType.includes('status');
                break;
            case 'interview':
                shouldShow = notificationType.includes('interview');
                break;
            case 'new_application':
                shouldShow = notificationType === 'new_application';
                break;
        }
        
        notification.style.display = shouldShow ? 'block' : 'none';
    });
    
    // Hide empty date groups
    document.querySelectorAll('.notification-group').forEach(group => {
        const visibleNotifications = group.querySelectorAll('.notification-item[style="display: block"], .notification-item:not([style*="display: none"])');
        group.style.display = visibleNotifications.length > 0 ? 'block' : 'none';
    });
}

function updateUnreadCount() {
    const unreadNotifications = document.querySelectorAll('.notification-item.unread');
    const unreadCountElement = document.getElementById('unreadCount');
    if (unreadCountElement) {
        unreadCountElement.textContent = unreadNotifications.length;
    }
    
    // Update navbar notification badge
    const navBadge = document.querySelector('.notification-badge');
    if (navBadge) {
        const count = unreadNotifications.length;
        navBadge.textContent = count;
        navBadge.style.display = count > 0 ? 'flex' : 'none';
    }
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('afterbegin', notification);
    
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Update unread count on page load
    updateUnreadCount();
    
    // Auto-refresh unread count every 30 seconds
    setInterval(function() {
        fetch('/api/notifications/unread_count')
            .then(response => response.json())
            .then(data => {
                const navBadge = document.querySelector('.notification-badge');
                if (navBadge) {
                    navBadge.textContent = data.count;
                    navBadge.style.display = data.count > 0 ? 'flex' : 'none';
                }
            })
            .catch(error => console.error('Error fetching unread count:', error));
    }, 30000);
});
</script>

{% endblock %}